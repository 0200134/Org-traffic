name: "Traffic Collector + Auto README Update"

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare output
        run: mkdir -p traffic

      - name: Collect Traffic
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=("Freeing-the-Lang" "Quad-brain-Foundation" "All-In-One-Foundation")

          TOTAL_VIEWS=0
          TOTAL_UNIQ_VIEWS=0
          TOTAL_CLONES=0
          TOTAL_UNIQ_CLONES=0

          REPORT=""
          REPORT+="| Repository | Views | Unique | Clones | Unique |\n"
          REPORT+="|-----------|-------|--------|--------|--------|\n"

          for ORG in "${ORGS[@]}"; do
            REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=200" | jq -r '.[].name')

            for REPO in $REPOS; do
              VIEWS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/views")
              CLONES_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/clones")

              VIEWS=$(echo "$VIEWS_JSON" | jq '.count // 0')
              VIEWS_UNIQ=$(echo "$VIEWS_JSON" | jq '.uniques // 0')
              CLONES=$(echo "$CLONES_JSON" | jq '.count // 0')
              CLONES_UNIQ=$(echo "$CLONES_JSON" | jq '.uniques // 0')

              TOTAL_VIEWS=$((TOTAL_VIEWS + VIEWS))
              TOTAL_UNIQ_VIEWS=$((TOTAL_UNIQ_VIEWS + VIEWS_UNIQ))
              TOTAL_CLONES=$((TOTAL_CLONES + CLONES))
              TOTAL_UNIQ_CLONES=$((TOTAL_UNIQ_CLONES + CLONES_UNIQ))

              REPORT+="| $ORG/$REPO | $VIEWS | $VIEWS_UNIQ | $CLONES | $CLONES_UNIQ |\n"
            done
          done

          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "TOTAL_VIEWS=$TOTAL_VIEWS" >> $GITHUB_OUTPUT
          echo "TOTAL_UNIQ_VIEWS=$TOTAL_UNIQ_VIEWS" >> $GITHUB_OUTPUT
          echo "TOTAL_CLONES=$TOTAL_CLONES" >> $GITHUB_OUTPUT
          echo "TOTAL_UNIQ_CLONES=$TOTAL_UNIQ_CLONES" >> $GITHUB_OUTPUT

      - name: Update README
        env:
          REPORT: ${{ steps.collect.outputs.REPORT }}
          V1: ${{ steps.collect.outputs.TOTAL_VIEWS }}
          V2: ${{ steps.collect.outputs.TOTAL_UNIQ_VIEWS }}
          C1: ${{ steps.collect.outputs.TOTAL_CLONES }}
          C2: ${{ steps.collect.outputs.TOTAL_UNIQ_CLONES }}
        run: |
          START="<!-- TRAFFIC-START -->"
          END="<!-- TRAFFIC-END -->"

          SUMMARY=$(cat << 'EOF'
**Total Views:** REPLACE_V1  
**Unique Views:** REPLACE_V2  
**Total Clones:** REPLACE_C1  
**Unique Clones:** REPLACE_C2  

### Repository Details  
REPLACE_REPORT
EOF
)

          SUMMARY="${SUMMARY/REPLACE_V1/$V1}"
          SUMMARY="${SUMMARY/REPLACE_V2/$V2}"
          SUMMARY="${SUMMARY/REPLACE_C1/$C1}"
          SUMMARY="${SUMMARY/REPLACE_C2/$C2}"
          SUMMARY="${SUMMARY/REPLACE_REPORT/$REPORT}"

          sed -i "/$START/,/$END/{ /$START/{p; echo \"$SUMMARY\"; }; /$END/p; d; }" README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Auto update traffic stats" || true
          git push
