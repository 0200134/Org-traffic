name: "Org Traffic Collector (All Repos)"

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare output
        run: mkdir traffic

      - name: Collect Traffic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=("Freeing-the-Lang" "Quad-brain-Foundation" "All-In-One-Foundation")

          echo "[]" > traffic/traffic-summary.json

          TOTAL_VIEWS=0
          TOTAL_VIEWS_UNIQ=0
          TOTAL_CLONES=0
          TOTAL_CLONES_UNIQ=0

          echo ""
          echo "=============================="
          echo "ðŸ”¥ TRAFFIC SUMMARY (ALL ORGS)"
          echo "=============================="
          echo ""

          for ORG in "${ORGS[@]}"; do
            echo ""
            echo "=== ORG: $ORG ==="

            REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/orgs/$ORG/repos?per_page=200" \
                | jq -r '.[].name')

            for REPO in $REPOS; do

              VIEWS=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/views")

              CLONES=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/clones")

              VIEWS_TOTAL=$(echo "$VIEWS" | jq '.count')
              VIEWS_UNIQ=$(echo "$VIEWS" | jq '.uniques')
              CLONES_TOTAL=$(echo "$CLONES" | jq '.count')
              CLONES_UNIQ=$(echo "$CLONES" | jq '.uniques')

              # ì½˜ì†” ìˆ«ìž ì¶œë ¥
              printf "â†’ %-35s | views: %4s (%2s uniq) | clones: %4s (%2s uniq)\n" \
                "$REPO" "$VIEWS_TOTAL" "$VIEWS_UNIQ" "$CLONES_TOTAL" "$CLONES_UNIQ"

              # ì „ì²´ í•©ì‚°
              TOTAL_VIEWS=$((TOTAL_VIEWS + VIEWS_TOTAL))
              TOTAL_VIEWS_UNIQ=$((TOTAL_VIEWS_UNIQ + VIEWS_UNIQ))
              TOTAL_CLONES=$((TOTAL_CLONES + CLONES_TOTAL))
              TOTAL_CLONES_UNIQ=$((TOTAL_CLONES_UNIQ + CLONES_UNIQ))

              # JSON ì €ìž¥
              jq --arg org "$ORG" \
                 --arg repo "$REPO" \
                 --argjson views "$VIEWS" \
                 --argjson clones "$CLONES" \
                 '. += [{
                    org:$org,
                    repo:$repo,
                    views:$views,
                    clones:$clones,
                    timestamp: now
                  }]' traffic/traffic-summary.json \
              > traffic/tmp.json

              mv traffic/tmp.json traffic/traffic-summary.json
            done
          done

          echo ""
          echo "=============================="
          echo "ðŸ”¥ TOTAL TRAFFIC (ALL ORGS)"
          echo "=============================="
          echo "Total Views:          $TOTAL_VIEWS"
          echo "Total Unique Views:   $TOTAL_VIEWS_UNIQ"
          echo "Total Clones:         $TOTAL_CLONES"
          echo "Total Unique Clones:  $TOTAL_CLONES_UNIQ"
          echo "=============================="
          echo ""

          # Convert to CSV
          jq -r '
            ["org","repo","total_views","unique_views","total_clones","unique_clones"],
            (.[] | [
              .org,
              .repo,
              .views.count,
              .views.uniques,
              .clones.count,
              .clones.uniques
            ])
            | @csv' traffic/traffic-summary.json \
          > traffic/traffic-summary.csv

      - name: Upload JSON
        uses: actions/upload-artifact@v4
        with:
          name: traffic-json
          path: traffic/traffic-summary.json

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: traffic-csv
          path: traffic/traffic-summary.csv
