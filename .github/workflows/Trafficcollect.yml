name: "Traffic Collector + Auto README Update"

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare output
        run: mkdir -p traffic

      - name: Collect Traffic
        id: collect
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=("Freeing-the-Lang" "Quad-brain-Foundation" "All-In-One-Foundation")

          TOTAL_VIEWS=0
          TOTAL_UNIQ_VIEWS=0
          TOTAL_CLONES=0
          TOTAL_UNIQ_CLONES=0

          REPORT_FILE="traffic/report.md"
          echo "| Repository | Views | Unique | Clones | Unique |" > $REPORT_FILE
          echo "|-----------|-------|--------|--------|--------|" >> $REPORT_FILE

          for ORG in "${ORGS[@]}"; do
            REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=200" | jq -r '.[].name')

            for REPO in $REPOS; do
              VIEWS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/views")
              CLONES_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/clones")

              VIEWS=$(echo "$VIEWS_JSON" | jq '.count // 0')
              VIEWS_UNIQ=$(echo "$VIEWS_JSON" | jq '.uniques // 0')
              CLONES=$(echo "$CLONES_JSON" | jq '.count // 0')
              CLONES_UNIQ=$(echo "$CLONES_JSON" | jq '.uniques // 0')

              TOTAL_VIEWS=$((TOTAL_VIEWS + VIEWS))
              TOTAL_UNIQ_VIEWS=$((TOTAL_UNIQ_VIEWS + VIEWS_UNIQ))
              TOTAL_CLONES=$((TOTAL_CLONES + CLONES))
              TOTAL_UNIQ_CLONES=$((TOTAL_UNIQ_CLONES + CLONES_UNIQ))

              echo "| $ORG/$REPO | $VIEWS | $VIEWS_UNIQ | $CLONES | $CLONES_UNIQ |" >> $REPORT_FILE
            done
          done

          echo "total_views=$TOTAL_VIEWS" >> $GITHUB_OUTPUT
          echo "total_unique_views=$TOTAL_UNIQ_VIEWS" >> $GITHUB_OUTPUT
          echo "total_clones=$TOTAL_CLONES" >> $GITHUB_OUTPUT
          echo "total_unique_clones=$TOTAL_UNIQ_CLONES" >> $GITHUB_OUTPUT

      - name: Update README
        env:
          V1: ${{ steps.collect.outputs.total_views }}
          V2: ${{ steps.collect.outputs.total_unique_views }}
          C1: ${{ steps.collect.outputs.total_clones }}
          C2: ${{ steps.collect.outputs.total_unique_clones }}
        run: |
          START="<!-- TRAFFIC-START -->"
          END="<!-- TRAFFIC-END -->"
          REPORT_FILE="traffic/report.md"

          SUMMARY_FILE="traffic/summary.md"
          cat <<EOF > $SUMMARY_FILE
**Total Views:** $V1  
**Unique Views:** $V2  
**Total Clones:** $C1  
**Unique Clones:** $C2  

### Repository Details
EOF

          cat "$REPORT_FILE" >> "$SUMMARY_FILE"

          # remove old section
          sed -i "/$START/,/$END/{ /$START/!{ /$END/!d; }; }" README.md

          # insert new section
          awk -v start="$START" -v file="$SUMMARY_FILE" '
            $0 ~ start {
              print;
              while ((getline line < file) > 0) print line;
              next
            }
            { print }
          ' README.md > README_tmp.md

          mv README_tmp.md README.md

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Auto update traffic stats" || true
          git push
