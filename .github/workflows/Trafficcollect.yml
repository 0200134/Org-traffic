name: "Org Traffic Collector (All Repos)"

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare output
        run: mkdir traffic

      - name: Collect Traffic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=("Freeing-the-Lang" "Quad-brain-Foundation" "All-In-One-Foundation")

          echo "[]" > traffic/traffic-summary.json

          for ORG in "${ORGS[@]}"; do
            echo "--- ORG: $ORG ---"

            REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/orgs/$ORG/repos?per_page=200" \
              | jq -r '.[].name')

            for REPO in $REPOS; do
              echo "â†’ $ORG/$REPO"

              VIEWS=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/views")

              CLONES=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/clones")

              jq --arg org "$ORG" \
                 --arg repo "$REPO" \
                 --argjson views "$VIEWS" \
                 --argjson clones "$CLONES" \
                 '. += [{
                    org:$org,
                    repo:$repo,
                    views:$views,
                    clones:$clones,
                    timestamp: now
                  }]' traffic/traffic-summary.json \
                > traffic/tmp.json

              mv traffic/tmp.json traffic/traffic-summary.json
            done
          done

          jq -r '
            ["org","repo","total_views","unique_views","total_clones","unique_clones"],
            (.[] | [
              .org,
              .repo,
              .views.count,
              .views.uniques,
              .clones.count,
              .clones.uniques
            ])
            | @csv' traffic/traffic-summary.json > traffic/traffic-summary.csv

      - name: Upload JSON
        uses: actions/upload-artifact@v4
        with:
          name: traffic-json
          path: traffic/traffic-summary.json

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: traffic-csv
          path: traffic/traffic-summary.csv
