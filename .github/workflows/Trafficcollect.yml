name: "Org Traffic Collector (auto, null-free)"

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare output
        run: mkdir traffic

      - name: Collect Traffic
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ORGS=("Freeing-the-Lang" "Quad-brain-Foundation" "All-In-One-Foundation")

          echo "[]" > traffic/traffic-summary.json

          TOTAL_VIEWS=0
          TOTAL_UNIQ_VIEWS=0
          TOTAL_CLONES=0
          TOTAL_UNIQ_CLONES=0

          echo ""
          echo "=============================="
          echo "ðŸ”¥ TRAFFIC REPORT (AUTO)"
          echo "=============================="

          for ORG in "${ORGS[@]}"; do
            echo ""
            echo "=== ORG: $ORG ==="

            REPOS=$(curl -s -H "Authorization: token $GH_TOKEN" \
                  "https://api.github.com/orgs/$ORG/repos?per_page=200" \
                  | jq -r '.[].name')

            for REPO in $REPOS; do

              VIEWS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/views")

              CLONES_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
                "https://api.github.com/repos/$ORG/$REPO/traffic/clones")

              # null ë°©ì§€ â†’ ìˆ«ìž ìžë™ 0 ì²˜ë¦¬
              VIEWS_TOTAL=$(echo "$VIEWS_JSON" | jq '.count // 0')
              VIEWS_UNIQ=$(echo "$VIEWS_JSON" | jq '.uniques // 0')
              CLONES_TOTAL=$(echo "$CLONES_JSON" | jq '.count // 0')
              CLONES_UNIQ=$(echo "$CLONES_JSON" | jq '.uniques // 0')

              printf "â†’ %-30s | views: %4s (%2s uniq) | clones: %4s (%2s uniq)\n" \
                "$REPO" "$VIEWS_TOTAL" "$VIEWS_UNIQ" "$CLONES_TOTAL" "$CLONES_UNIQ"

              TOTAL_VIEWS=$((TOTAL_VIEWS + VIEWS_TOTAL))
              TOTAL_UNIQ_VIEWS=$((TOTAL_UNIQ_VIEWS + VIEWS_UNIQ))
              TOTAL_CLONES=$((TOTAL_CLONES + CLONES_TOTAL))
              TOTAL_UNIQ_CLONES=$((TOTAL_UNIQ_CLONES + CLONES_UNIQ))

              # JSON append
              jq --arg org "$ORG" \
                 --arg repo "$REPO" \
                 --argjson views "$VIEWS_JSON" \
                 --argjson clones "$CLONES_JSON" \
                 '. += [{
                    org:$org,
                    repo:$repo,
                    views:($views + {count: ($views.count // 0), uniques: ($views.uniques // 0)}),
                    clones:($clones + {count: ($clones.count // 0), uniques: ($clones.uniques // 0)}),
                    timestamp: now
                  }]' traffic/traffic-summary.json \
              > traffic/tmp.json

              mv traffic/tmp.json traffic/traffic-summary.json

            done
          done

          echo ""
          echo "=============================="
          echo "ðŸ”¥ TRAFFIC TOTAL (AUTO)"
          echo "=============================="
          echo "Total Views:          $TOTAL_VIEWS"
          echo "Total Unique Views:   $TOTAL_UNIQ_VIEWS"
          echo "Total Clones:         $TOTAL_CLONES"
          echo "Total Unique Clones:  $TOTAL_UNIQ_CLONES"
          echo "=============================="
          echo ""

          # CSV ìƒì„±
          jq -r '
            ["org","repo","views","views_unique","clones","clones_unique"],
            (.[] | [
              .org,
              .repo,
              .views.count,
              .views.uniques,
              .clones.count,
              .clones.uniques
            ]) | @csv' \
          traffic/traffic-summary.json \
          > traffic/traffic-summary.csv

      - name: Upload JSON
        uses: actions/upload-artifact@v4
        with:
          name: traffic-json
          path: traffic/traffic-summary.json

      - name: Upload CSV
        uses: actions/upload-artifact@v4
        with:
          name: traffic-csv
          path: traffic/traffic-summary.csv
